
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>automation.DataAggregator.BaseAggregator &#8212; OpenWPM  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for automation.DataAggregator.BaseAggregator</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span> <span class="nn">multiprocess</span> <span class="kn">import</span> <span class="n">Queue</span>

<span class="kn">from</span> <span class="nn">..SocketInterface</span> <span class="kn">import</span> <span class="n">serversocket</span>
<span class="kn">from</span> <span class="nn">..utilities.multiprocess_utils</span> <span class="kn">import</span> <span class="n">Process</span>

<span class="n">RECORD_TYPE_CONTENT</span> <span class="o">=</span> <span class="s1">&#39;page_content&#39;</span>
<span class="n">STATUS_TIMEOUT</span> <span class="o">=</span> <span class="mi">120</span>  <span class="c1"># seconds</span>
<span class="n">SHUTDOWN_SIGNAL</span> <span class="o">=</span> <span class="s1">&#39;SHUTDOWN&#39;</span>

<span class="n">STATUS_UPDATE_INTERVAL</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># seconds</span>

<span class="n">BaseParams</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Queue</span><span class="p">,</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Queue</span><span class="p">]</span>


<div class="viewcode-block" id="BaseListener"><a class="viewcode-back" href="../../../source/automation.DataAggregator.html#automation.DataAggregator.BaseAggregator.BaseListener">[docs]</a><span class="k">class</span> <span class="nc">BaseListener</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class for the data aggregator listener process. This class is used</span>
<span class="sd">    alongside the BaseAggregator class to spawn an aggregator process that</span>
<span class="sd">    combines data collected in multiple crawl processes and stores it</span>
<span class="sd">    persistently as specified in the child class. The BaseListener class</span>
<span class="sd">    is instantiated in the remote process, and sets up a listening socket to</span>
<span class="sd">    receive data. Classes which inherit from this base class define</span>
<span class="sd">    how that data is written to disk.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__metaclass</span> <span class="o">=</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span>

<div class="viewcode-block" id="BaseListener.__init__"><a class="viewcode-back" href="../../../source/automation.DataAggregator.html#automation.DataAggregator.BaseAggregator.BaseListener.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_queue</span><span class="p">:</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">completion_queue</span><span class="p">:</span> <span class="n">Queue</span><span class="p">,</span>
                 <span class="n">shutdown_queue</span><span class="p">:</span> <span class="n">Queue</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a BaseListener instance</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        status_queue</span>
<span class="sd">            queue that the current amount of records to be processed will</span>
<span class="sd">            be sent to</span>
<span class="sd">            also used for initialization</span>
<span class="sd">        completion_queue</span>
<span class="sd">            queue containing the visitIDs of saved records</span>
<span class="sd">        shutdown_queue</span>
<span class="sd">            queue that the main process can use to shut down the listener</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_queue</span> <span class="o">=</span> <span class="n">status_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completion_queue</span> <span class="o">=</span> <span class="n">completion_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_queue</span> <span class="o">=</span> <span class="n">shutdown_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_update</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># last status update time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record_queue</span><span class="p">:</span> <span class="n">Queue</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialized on `startup`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;openwpm&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># maps crawl_id to visit_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">:</span> <span class="n">serversocket</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="BaseListener.process_record"><a class="viewcode-back" href="../../../source/automation.DataAggregator.html#automation.DataAggregator.BaseAggregator.BaseListener.process_record">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">process_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse and save `record` to persistent storage.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        record : tuple</span>
<span class="sd">            2-tuple in format (table_name, data). `data` is a dict which maps</span>
<span class="sd">            column name to the record for that column&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="BaseListener.process_content"><a class="viewcode-back" href="../../../source/automation.DataAggregator.html#automation.DataAggregator.BaseAggregator.BaseListener.process_content">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">process_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse and save page content `record` to persistent storage.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        record : tuple</span>
<span class="sd">            2-tuple in format (table_name, data). `data` is a 2-tuple of the</span>
<span class="sd">            for (content, content_hash)&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="BaseListener.run_visit_completion_tasks"><a class="viewcode-back" href="../../../source/automation.DataAggregator.html#automation.DataAggregator.BaseAggregator.BaseListener.run_visit_completion_tasks">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">run_visit_completion_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visit_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                   <span class="n">interrupted</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Will be called once a visit_id will receive no new records</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        visit_id</span>
<span class="sd">            the id that will receive no more updates</span>
<span class="sd">        interrupted</span>
<span class="sd">            if this call is made during shutdown&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="BaseListener.startup"><a class="viewcode-back" href="../../../source/automation.DataAggregator.html#automation.DataAggregator.BaseAggregator.BaseListener.startup">[docs]</a>    <span class="k">def</span> <span class="nf">startup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run listener startup tasks</span>

<span class="sd">        Note: Child classes should call this method&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">serversocket</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">getsockname</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">start_accepting</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">queue</span></div>

<div class="viewcode-block" id="BaseListener.should_shutdown"><a class="viewcode-back" href="../../../source/automation.DataAggregator.html#automation.DataAggregator.BaseAggregator.BaseListener.should_shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">should_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return `True` if the listener has received a shutdown signal</span>
<span class="sd">        Sets `self._relaxed` and `self.shutdown_flag`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">relaxed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_relaxed</span> <span class="o">=</span> <span class="n">relaxed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Received shutdown signal!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="BaseListener.update_status_queue"><a class="viewcode-back" href="../../../source/automation.DataAggregator.html#automation.DataAggregator.BaseAggregator.BaseListener.update_status_queue">[docs]</a>    <span class="k">def</span> <span class="nf">update_status_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send manager process a status update.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_update</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">STATUS_UPDATE_INTERVAL</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">qsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_queue</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">qsize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Status update; current record queue size: </span><span class="si">%d</span><span class="s2">. &quot;</span>
            <span class="s2">&quot;current number of threads: </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">qsize</span><span class="p">,</span> <span class="n">threading</span><span class="o">.</span><span class="n">active_count</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_update</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>

<div class="viewcode-block" id="BaseListener.update_records"><a class="viewcode-back" href="../../../source/automation.DataAggregator.html#automation.DataAggregator.BaseAggregator.BaseListener.update_records">[docs]</a>    <span class="k">def</span> <span class="nf">update_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;A method to keep track of which browser is working on which visit_id</span>
<span class="sd">           If browser_id or visit_id should not be said in data this method</span>
<span class="sd">           will raise an exception</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">visit_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">crawl_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># All data records should be keyed by the crawler and site visit</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">visit_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;visit_id&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Record for table </span><span class="si">%s</span><span class="s2"> has no visit id&quot;</span> <span class="o">%</span> <span class="n">table</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="k">raise</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">crawl_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;crawl_id&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Record for table </span><span class="si">%s</span><span class="s2"> has no crawl id&quot;</span> <span class="o">%</span> <span class="n">table</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="k">raise</span>

        <span class="c1"># Check if the browser for this record has moved on to a new visit</span>
        <span class="k">if</span> <span class="n">crawl_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser_map</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">browser_map</span><span class="p">[</span><span class="n">crawl_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">visit_id</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser_map</span><span class="p">[</span><span class="n">crawl_id</span><span class="p">]</span> <span class="o">!=</span> <span class="n">visit_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_visit_completion_tasks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">browser_map</span><span class="p">[</span><span class="n">crawl_id</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">browser_map</span><span class="p">[</span><span class="n">crawl_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">visit_id</span>

        <span class="k">return</span> <span class="n">crawl_id</span><span class="p">,</span> <span class="n">visit_id</span></div>

<div class="viewcode-block" id="BaseListener.mark_visit_complete"><a class="viewcode-back" href="../../../source/automation.DataAggregator.html#automation.DataAggregator.BaseAggregator.BaseListener.mark_visit_complete">[docs]</a>    <span class="k">def</span> <span class="nf">mark_visit_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visit_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This function should be called to indicate that all records</span>
<span class="sd">        relating to a certain visit_id have been saved&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completion_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">visit_id</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span></div>

<div class="viewcode-block" id="BaseListener.shutdown"><a class="viewcode-back" href="../../../source/automation.DataAggregator.html#automation.DataAggregator.BaseAggregator.BaseListener.shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run shutdown tasks defined in the base listener</span>

<span class="sd">        Note: Child classes should call this method&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">visit_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser_map</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_visit_completion_tasks</span><span class="p">(</span><span class="n">visit_id</span><span class="p">,</span> <span class="n">interrupted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseListener.drain_queue"><a class="viewcode-back" href="../../../source/automation.DataAggregator.html#automation.DataAggregator.BaseAggregator.BaseListener.drain_queue">[docs]</a>    <span class="k">def</span> <span class="nf">drain_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Ensures queue is empty before closing &quot;&quot;&quot;</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># TODO: the socket needs a better way of closing</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_record</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Queue was flushed completely&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BaseAggregator"><a class="viewcode-back" href="../../../source/automation.DataAggregator.html#automation.DataAggregator.BaseAggregator.BaseAggregator">[docs]</a><span class="k">class</span> <span class="nc">BaseAggregator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class for the data aggregator interface. This class is used</span>
<span class="sd">    alongside the BaseListener class to spawn an aggregator process that</span>
<span class="sd">    combines data from multiple crawl processes. The BaseAggregator class</span>
<span class="sd">    manages the child listener process.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    manager_params : dict</span>
<span class="sd">        TaskManager configuration parameters</span>
<span class="sd">    browser_params : list of dict</span>
<span class="sd">        List of browser configuration dictionaries&quot;&quot;&quot;</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager_params</span><span class="p">,</span> <span class="n">browser_params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager_params</span> <span class="o">=</span> <span class="n">manager_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser_params</span> <span class="o">=</span> <span class="n">browser_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener_address</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener_process</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completion_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_status_received</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;openwpm&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="BaseAggregator.save_configuration"><a class="viewcode-back" href="../../../source/automation.DataAggregator.html#automation.DataAggregator.BaseAggregator.BaseAggregator.save_configuration">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">save_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">openwpm_version</span><span class="p">,</span> <span class="n">browser_version</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save configuration details to the database&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="BaseAggregator.get_next_visit_id"><a class="viewcode-back" href="../../../source/automation.DataAggregator.html#automation.DataAggregator.BaseAggregator.BaseAggregator.get_next_visit_id">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_next_visit_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a unique visit ID to be used as a key for a single visit&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="BaseAggregator.get_next_crawl_id"><a class="viewcode-back" href="../../../source/automation.DataAggregator.html#automation.DataAggregator.BaseAggregator.BaseAggregator.get_next_crawl_id">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_next_crawl_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a unique crawl ID used as a key for a browser instance&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="BaseAggregator.get_most_recent_status"><a class="viewcode-back" href="../../../source/automation.DataAggregator.html#automation.DataAggregator.BaseAggregator.BaseAggregator.get_most_recent_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_most_recent_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the most recent queue size sent from the listener process&quot;&quot;&quot;</span>

        <span class="c1"># Block until we receive the first status update</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>

        <span class="c1"># Drain status queue until we receive most recent update</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_status_received</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Check last status signal</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_status_received</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">STATUS_TIMEOUT</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;No status update from DataAggregator listener process &quot;</span>
                <span class="s2">&quot;for </span><span class="si">%d</span><span class="s2"> seconds.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_status_received</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_status</span></div>

<div class="viewcode-block" id="BaseAggregator.get_status"><a class="viewcode-back" href="../../../source/automation.DataAggregator.html#automation.DataAggregator.BaseAggregator.BaseAggregator.get_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get listener process status. If the status queue is empty, block.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">STATUS_TIMEOUT</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_status_received</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;No status update from DataAggregator listener process &quot;</span>
                <span class="s2">&quot;for </span><span class="si">%d</span><span class="s2"> seconds.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_status_received</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_status</span></div>

<div class="viewcode-block" id="BaseAggregator.get_new_completed_visits"><a class="viewcode-back" href="../../../source/automation.DataAggregator.html#automation.DataAggregator.BaseAggregator.BaseAggregator.get_new_completed_visits">[docs]</a>    <span class="k">def</span> <span class="nf">get_new_completed_visits</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of all visit ids that have been saved at the time</span>
<span class="sd">        of calling this method.</span>
<span class="sd">        This method will return an empty list in case no visit ids have</span>
<span class="sd">        been finished since the last time this method was called&quot;&quot;&quot;</span>
        <span class="n">finished_visit_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">completion_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">finished_visit_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">completion_queue</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">finished_visit_ids</span></div>

<div class="viewcode-block" id="BaseAggregator.launch"><a class="viewcode-back" href="../../../source/automation.DataAggregator.html#automation.DataAggregator.BaseAggregator.BaseAggregator.launch">[docs]</a>    <span class="k">def</span> <span class="nf">launch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">listener_process_runner</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Launch the aggregator listener process&quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">status_queue</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">completion_queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_queue</span><span class="p">),)</span> <span class="o">+</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener_process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">listener_process_runner</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="n">args</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener_process</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener_process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="BaseAggregator.shutdown"><a class="viewcode-back" href="../../../source/automation.DataAggregator.html#automation.DataAggregator.BaseAggregator.BaseAggregator.shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relaxed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Terminate the aggregator listener process&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Sending the shutdown signal to the </span><span class="si">%s</span><span class="s2"> listener process...&quot;</span> <span class="o">%</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">SHUTDOWN_SIGNAL</span><span class="p">,</span> <span class="n">relaxed</span><span class="p">))</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener_process</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> took </span><span class="si">%s</span><span class="s2"> seconds to close.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener_address</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener_process</span> <span class="o">=</span> <span class="kc">None</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">OpenWPM</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../CommandSequence.html">The Lifetime of a CommandSequence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../MarkAsIncomplete.html">Shutdown and Saving</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Mozilla.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.0.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>